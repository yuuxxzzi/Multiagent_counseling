# RoleplayAgent 워크플로우 다이어그램

## 메인 실행 흐름 (run 메서드)

```
                    ┌─────────────────┐
                    │   시작 (run)    │
                    └─────────┬───────┘
                              │
                    ┌─────────▼───────┐
                    │ 1. 맥락 추출     │
                    │ _extract_context │
                    └─────────┬───────┘
                              │
                    ┌─────────▼───────┐
                    │ 2. 슬롯 수집     │
                    │ _collect_slots   │
                    └─────────┬───────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 슬롯이 부족한가? │
                    └─────────┬───────┘
                              │
                    ┌─────────▼───────┐
                    │      YES        │
                    └─────────┬───────┘
                              │
                    ┌─────────▼───────┐
                    │ 3a. 사전 확인    │
                    │ 질문 생성        │
                    └─────────┬───────┘
                              │
                    ┌─────────▼───────┐
                    │ 안전 스캔        │
                    │ _safety_scan     │
                    └─────────┬───────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 하드 임계어     │
                    │ 감지되었는가?   │
                    └─────────┬───────┘
                              │
                    ┌─────────▼───────┐
                    │      YES        │
                    └─────────┬───────┘
                              │
                    ┌─────────▼───────┐
                    │ mindfulness_    │
                    │ agent로 분기    │
                    └─────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │      NO         │
                    └─────────┬───────┘
                              │
                    ┌─────────▼───────┐
                    │ counselor_agent │
                    │ (답변 대기)     │
                    └─────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │      NO         │
                    └─────────┬───────┘
                              │
                    ┌─────────▼───────┐
                    │ 3b. 유형 추정    │
                    │ _infer_type      │
                    └─────────┬───────┘
                              │
                    ┌─────────▼───────┐
                    │ 4. 시나리오 생성 │
                    │ _build_scenario  │
                    └─────────┬───────┘
                              │
                    ┌─────────▼───────┐
                    │ 5. 안전 스캔     │
                    │ _safety_scan     │
                    └─────────┬───────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 하드 임계어 또는 │
                    │ 위험어 ≥3개?    │
                    └─────────┬───────┘
                              │
                    ┌─────────▼───────┐
                    │      YES        │
                    └─────────┬───────┘
                              │
                    ┌─────────▼───────┐
                    │ mindfulness_    │
                    │ agent로 분기    │
                    └─────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │      NO         │
                    └─────────┬───────┘
                              │
                    ┌─────────▼───────┐
                    │ 6. 상태 갱신     │
                    │ - roleplay_count │
                    │ - roleplay_logs  │
                    │ - interventions  │
                    │ - messages       │
                    └─────────┬───────┘
                              │
                    ┌─────────▼───────┐
                    │ counselor_agent │
                    │ (상담사 복귀)   │
                    └─────────────────┘
```

## 유형 분류 로직 (_infer_type)

```
                    ┌─────────────────┐
                    │ 토픽 텍스트     │
                    └─────────┬───────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ "과거/예전/     │
                    │ 기억/떠올라"    │
                    └─────────┬───────┘
                              │
                    ┌─────────▼───────┐
                    │      YES        │
                    └─────────┬───────┘
                              │
                    ┌─────────▼───────┐
                    │   A형 반환      │
                    │ (과거 상황 재현) │
                    └─────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ "내일/면접/     │
                    │ 발표/앞으로"    │
                    └─────────┬───────┘
                              │
                    ┌─────────▼───────┐
                    │      YES        │
                    └─────────┬───────┘
                              │
                    ┌─────────▼───────┐
                    │   B형 반환      │
                    │ (미래 상황 연습) │
                    └─────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ "관계/갈등/     │
                    │ 상사/가족"      │
                    └─────────┬───────┘
                              │
                    ┌─────────▼───────┐
                    │      YES        │
                    └─────────┬───────┘
                              │
                    ┌─────────▼───────┐
                    │   C형 반환      │
                    │ (관계 역할 바꾸기)│
                    └─────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ "이상적/이상향/ │
                    │ 원하는자아"     │
                    └─────────┬───────┘
                              │
                    ┌─────────▼───────┐
                    │      YES        │
                    └─────────┬───────┘
                              │
                    ┌─────────▼───────┐
                    │   D형 반환      │
                    │ (이상적 자아 연습)│
                    └─────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │   A형 반환      │
                    │ (기본값)        │
                    └─────────────────┘
```

## 안전 스캔 로직 (_safety_scan)

```
                    ┌─────────────────┐
                    │ 입력 텍스트     │
                    └─────────┬───────┘
                              │
                    ┌─────────▼───────┐
                    │ 텍스트를 소문자로│
                    │ 변환            │
                    └─────────┬───────┘
                              │
                    ┌─────────▼───────┐
                    │ 위험어 카운트   │
                    │ _SAFETY_KEYWORDS │
                    └─────────┬───────┘
                              │
                    ┌─────────▼───────┐
                    │ 하드 임계어     │
                    │ _HARD_RISK      │
                    │ 검사            │
                    └─────────┬───────┘
                              │
                    ┌─────────▼───────┐
                    │ (카운트, 하드)  │
                    │ 튜플 반환       │
                    └─────────────────┘
```

## 시나리오 생성 구조 (_build_scenario)

```
                    ┌─────────────────┐
                    │ 입력 파라미터   │
                    │ - rtype         │
                    │ - persona       │
                    │ - slots         │
                    │ - ctx_text      │
                    └─────────┬───────┘
                              │
                    ┌─────────▼───────┐
                    │ 유형별 기법     │
                    │ _TECHNIQUE_BY_   │
                    │ TYPE에서 선택   │
                    └─────────┬───────┘
                              │
                    ┌─────────▼───────┐
                    │ GPT 프롬프트    │
                    │ 구성            │
                    │ - 페르소나      │
                    │ - 유형/기법     │
                    │ - 상담 맥락     │
                    │ - 슬롯 정보     │
                    └─────────┬───────┘
                              │
                    ┌─────────▼───────┐
                    │ GPT-4o 호출     │
                    │ 시나리오 생성   │
                    └─────────┬───────┘
                              │
                    ┌─────────▼───────┐
                    │ 3단계 템플릿    │
                    │ 1) 안전수칙     │
                    │ 2) 준비→연기    │
                    │ 3) 정리         │
                    └─────────────────┘
```

## 주요 분기점 요약

```
                    ┌─────────────────┐
                    │ RoleplayAgent   │
                    │ 시작            │
                    └─────────┬───────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 슬롯 부족?      │
                    └─────────┬───────┘
                              │
                    ┌─────────▼───────┐
                    │ YES → 사전 확인  │
                    │ 질문 → counselor │
                    └─────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 하드 임계어?    │
                    └─────────┬───────┘
                              │
                    ┌─────────▼───────┐
                    │ YES → mindfulness│
                    │ (위기 개입)     │
                    └─────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ NO → 정상 진행  │
                    │ 시나리오 생성   │
                    └─────────┬───────┘
                              │
                    ┌─────────▼───────┐
                    │ counselor_agent │
                    │ (상담사 복귀)   │
                    └─────────────────┘
```
